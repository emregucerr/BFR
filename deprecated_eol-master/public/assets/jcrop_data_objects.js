$(function(){function e(e){parseInt(e.w)>0&&$("#crop_panel .crop_preview img").each(function(){var t=$(this).parent().width()/e.w,i=$(this).parent().width()/e.h;$(this).attr("src",o.attr("src")),$(this).css({width:Math.round(t*o.width())+"px",height:Math.round(i*o.height())+"px",marginLeft:"-"+Math.round(t*e.x)+"px",marginTop:"-"+Math.round(i*e.y)+"px",visibility:"visible"}).show()})}function t(){$("#crop_panel .crop_preview img").each(function(){$(this).stop(),$(this).attr("style",""),$(this).attr("src",$(this).attr("original_src"))})}function i(e){var t=o[0].naturalWidth,i=o[0].naturalHeight;if("undefined"==typeof t){var s=new Image;s.onload=function(){n(this.width,this.height,e)},s.src=o[0].src}else n(t,i,e)}function n(e,t,i){var n=1;1.5>e/t?t>360&&(n=t/360):e>540&&(n=e/540),a.children('[name="x"]').val(100*i.x*n/e),a.children('[name="y"]').val(100*i.y*n/t),a.children('[name="w"]').val(100*i.w*n/e)}function s(){return parseInt(a.children('[name="w"]').val())>0?!0:(alert('Please select a crop region in the larger image, then press "crop image".'),!1)}var o=$("#permalink img:first"),a=$("#crop_form form");o.Jcrop({onChange:e,onSelect:i,onRelease:t,minSize:[50,50],addClass:"auto_margin",aspectRatio:1}),o.closest("a").on("click",function(e){e.preventDefault()}),a.submit(function(){return s()})});