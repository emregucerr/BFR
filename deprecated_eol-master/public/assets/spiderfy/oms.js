/** @preserve OverlappingMarkerSpiderfier
https://github.com/jawj/OverlappingMarkerSpiderfier
Copyright (c) 2011 - 2012 George MacKerron
Released under the MIT licence: http://opensource.org/licenses/mit-license
Note: The Google Maps API v3 must be included *before* this code
*/
(function(){var t,e={}.hasOwnProperty,r=[].slice;null!=(null!=(t=this.google)?t.maps:void 0)&&(this.OverlappingMarkerSpiderfier=function(){function t(t,r){var i,n,a,s,l,p,h=this;this.map=t,null==r&&(r={});for(n in r)e.call(r,n)&&(a=r[n],this[n]=a);for(this.projHelper=new this.constructor.ProjHelper(this.map),this.initMarkerArrays(),this.listeners={},p=["click","zoom_changed","maptypeid_changed"],s=0,l=p.length;l>s;s++)i=p[s],o.addListener(this.map,i,function(){return h.unspiderfy()})}var o,i,n,a,s,l,p,h,u,c,d;for(l=t.prototype,d=[t,l],u=0,c=d.length;c>u;u++)h=d[u],h.VERSION="0.3.3";return i=google.maps,o=i.event,s=i.MapTypeId,p=2*Math.PI,l.keepSpiderfied=!1,l.markersWontHide=!1,l.markersWontMove=!1,l.nearbyDistance=20,l.circleSpiralSwitchover=9,l.circleFootSeparation=23,l.circleStartAngle=p/12,l.spiralFootSeparation=26,l.spiralLengthStart=11,l.spiralLengthFactor=4,l.spiderfiedZIndex=1e3,l.usualLegZIndex=10,l.highlightedLegZIndex=20,l.legWeight=1.5,l.legColors={usual:{},highlighted:{}},a=l.legColors.usual,n=l.legColors.highlighted,a[s.HYBRID]=a[s.SATELLITE]="#fff",n[s.HYBRID]=n[s.SATELLITE]="#f00",a[s.TERRAIN]=a[s.ROADMAP]="#444",n[s.TERRAIN]=n[s.ROADMAP]="#f00",l.initMarkerArrays=function(){return this.markers=[],this.markerListenerRefs=[]},l.addMarker=function(t){var e,r=this;return null!=t._oms?this:(t._oms=!0,e=[o.addListener(t,"click",function(e){return r.spiderListener(t,e)})],this.markersWontHide||e.push(o.addListener(t,"visible_changed",function(){return r.markerChangeListener(t,!1)})),this.markersWontMove||e.push(o.addListener(t,"position_changed",function(){return r.markerChangeListener(t,!0)})),this.markerListenerRefs.push(e),this.markers.push(t),this)},l.markerChangeListener=function(t,e){return null==t._omsData||!e&&t.getVisible()||null!=this.spiderfying||null!=this.unspiderfying?void 0:this.unspiderfy(e?t:null)},l.getMarkers=function(){return this.markers.slice(0)},l.removeMarker=function(t){var e,r,i,n,a;if(null!=t._omsData&&this.unspiderfy(),e=this.arrIndexOf(this.markers,t),0>e)return this;for(i=this.markerListenerRefs.splice(e,1)[0],n=0,a=i.length;a>n;n++)r=i[n],o.removeListener(r);return delete t._oms,this.markers.splice(e,1),this},l.clearMarkers=function(){var t,e,r,i,n,a,s,l,p;for(this.unspiderfy(),p=this.markers,t=n=0,s=p.length;s>n;t=++n){for(i=p[t],r=this.markerListenerRefs[t],a=0,l=r.length;l>a;a++)e=r[a],o.removeListener(e);delete i._oms}return this.initMarkerArrays(),this},l.addListener=function(t,e){var r,o;return(null!=(o=(r=this.listeners)[t])?o:r[t]=[]).push(e),this},l.removeListener=function(t,e){var r;return r=this.arrIndexOf(this.listeners[t],e),0>r||this.listeners[t].splice(r,1),this},l.clearListeners=function(t){return this.listeners[t]=[],this},l.trigger=function(){var t,e,o,i,n,a,s,l;for(e=arguments[0],t=2<=arguments.length?r.call(arguments,1):[],s=null!=(a=this.listeners[e])?a:[],l=[],i=0,n=s.length;n>i;i++)o=s[i],l.push(o.apply(null,t));return l},l.generatePtsCircle=function(t,e){var r,o,n,a,s,l,h;for(n=this.circleFootSeparation*(2+t),s=n/p,o=p/t,h=[],a=l=0;t>=0?t>l:l>t;a=t>=0?++l:--l)r=this.circleStartAngle+a*o,h.push(new i.Point(e.x+s*Math.cos(r),e.y+s*Math.sin(r)));return h},l.generatePtsSpiral=function(t,e){var r,o,n,a,s,l;for(n=this.spiralLengthStart,r=0,l=[],o=s=0;t>=0?t>s:s>t;o=t>=0?++s:--s)r+=this.spiralFootSeparation/n+5e-4*o,a=new i.Point(e.x+n*Math.cos(r),e.y+n*Math.sin(r)),n+=p*this.spiralLengthFactor/r,l.push(a);return l},l.spiderListener=function(t,e){var r,o,i,n,a,s,l,p,h,u,c;if(n=null!=t._omsData,n&&this.keepSpiderfied||this.unspiderfy(),n||this.map.getStreetView().getVisible()||"GoogleEarthAPI"===this.map.getMapTypeId())return this.trigger("click",t,e);for(s=[],l=[],a=this.nearbyDistance,p=a*a,i=this.llToPt(t.position),c=this.markers,h=0,u=c.length;u>h;h++)r=c[h],null!=r.map&&r.getVisible()&&(o=this.llToPt(r.position),this.ptDistanceSq(o,i)<p?s.push({marker:r,markerPt:o}):l.push(r));return 1===s.length?this.trigger("click",t,e):this.spiderfy(s,l)},l.markersNearMarker=function(t,e){var r,o,i,n,a,s,l,p,h,u,c;if(null==e&&(e=!1),null==this.projHelper.getProjection())throw"Must wait for 'idle' event on map before calling markersNearMarker";for(a=this.nearbyDistance,s=a*a,i=this.llToPt(t.position),n=[],h=this.markers,l=0,p=h.length;p>l&&(r=h[l],!(r!==t&&null!=r.map&&r.getVisible()&&(o=this.llToPt(null!=(u=null!=(c=r._omsData)?c.usualPosition:void 0)?u:r.position),this.ptDistanceSq(o,i)<s&&(n.push(r),e))));l++);return n},l.markersNearAnyOtherMarker=function(){var t,e,r,o,i,n,a,s,l,p,h,u,c,d,g,m,f,y,v,M,k;if(null==this.projHelper.getProjection())throw"Must wait for 'idle' event on map before calling markersNearAnyOtherMarker";for(p=this.nearbyDistance,h=p*p,l=function(){var t,e,r,i,n,a;for(r=this.markers,a=[],t=0,e=r.length;e>t;t++)o=r[t],a.push({pt:this.llToPt(null!=(i=null!=(n=o._omsData)?n.usualPosition:void 0)?i:o.position),willSpiderfy:!1});return a}.call(this),y=this.markers,e=u=0,g=y.length;g>u;e=++u)if(i=y[e],null!=i.map&&i.getVisible()&&(n=l[e],!n.willSpiderfy))for(v=this.markers,r=c=0,m=v.length;m>c;r=++c)if(a=v[r],r!==e&&null!=a.map&&a.getVisible()&&(s=l[r],(!(e>r)||s.willSpiderfy)&&this.ptDistanceSq(n.pt,s.pt)<h)){n.willSpiderfy=s.willSpiderfy=!0;break}for(M=this.markers,k=[],t=d=0,f=M.length;f>d;t=++d)o=M[t],l[t].willSpiderfy&&k.push(o);return k},l.makeHighlightListenerFuncs=function(t){var e=this;return{highlight:function(){return t._omsData.leg.setOptions({strokeColor:e.legColors.highlighted[e.map.mapTypeId],zIndex:e.highlightedLegZIndex})},unhighlight:function(){return t._omsData.leg.setOptions({strokeColor:e.legColors.usual[e.map.mapTypeId],zIndex:e.usualLegZIndex})}}},l.spiderfy=function(t,e){var r,n,a,s,l,p,h,u,c,d,g;return this.spiderfying=!0,d=t.length,r=this.ptAverage(function(){var e,r,o;for(o=[],e=0,r=t.length;r>e;e++)u=t[e],o.push(u.markerPt);return o}()),s=d>=this.circleSpiralSwitchover?this.generatePtsSpiral(d,r).reverse():this.generatePtsCircle(d,r),g=function(){var e,r,u,d=this;for(u=[],e=0,r=s.length;r>e;e++)a=s[e],n=this.ptToLl(a),c=this.minExtract(t,function(t){return d.ptDistanceSq(t.markerPt,a)}),h=c.marker,p=new i.Polyline({map:this.map,path:[h.position,n],strokeColor:this.legColors.usual[this.map.mapTypeId],strokeWeight:this.legWeight,zIndex:this.usualLegZIndex}),h._omsData={usualPosition:h.position,leg:p},this.legColors.highlighted[this.map.mapTypeId]!==this.legColors.usual[this.map.mapTypeId]&&(l=this.makeHighlightListenerFuncs(h),h._omsData.hightlightListeners={highlight:o.addListener(h,"mouseover",l.highlight),unhighlight:o.addListener(h,"mouseout",l.unhighlight)}),h.setPosition(n),h.setZIndex(Math.round(this.spiderfiedZIndex+a.y)),u.push(h);return u}.call(this),delete this.spiderfying,this.spiderfied=!0,this.trigger("spiderfy",g,e)},l.unspiderfy=function(t){var e,r,i,n,a,s,l;if(null==t&&(t=null),null==this.spiderfied)return this;for(this.unspiderfying=!0,n=[],i=[],l=this.markers,a=0,s=l.length;s>a;a++)r=l[a],null!=r._omsData?(r._omsData.leg.setMap(null),r!==t&&r.setPosition(r._omsData.usualPosition),r.setZIndex(null),e=r._omsData.hightlightListeners,null!=e&&(o.removeListener(e.highlight),o.removeListener(e.unhighlight)),delete r._omsData,n.push(r)):i.push(r);return delete this.unspiderfying,delete this.spiderfied,this.trigger("unspiderfy",n,i),this},l.ptDistanceSq=function(t,e){var r,o;return r=t.x-e.x,o=t.y-e.y,r*r+o*o},l.ptAverage=function(t){var e,r,o,n,a,s;for(o=n=0,a=0,s=t.length;s>a;a++)r=t[a],o+=r.x,n+=r.y;return e=t.length,new i.Point(o/e,n/e)},l.llToPt=function(t){return this.projHelper.getProjection().fromLatLngToDivPixel(t)},l.ptToLl=function(t){return this.projHelper.getProjection().fromDivPixelToLatLng(t)},l.minExtract=function(t,e){var r,o,i,n,a,s,l;for(i=s=0,l=t.length;l>s;i=++s)n=t[i],a=e(n),("undefined"==typeof r||null===r||o>a)&&(o=a,r=i);return t.splice(r,1)[0]},l.arrIndexOf=function(t,e){var r,o,i,n;if(null!=t.indexOf)return t.indexOf(e);for(r=i=0,n=t.length;n>i;r=++i)if(o=t[r],o===e)return r;return-1},t.ProjHelper=function(t){return this.setMap(t)},t.ProjHelper.prototype=new i.OverlayView,t.ProjHelper.prototype.draw=function(){},t}())}).call(this);